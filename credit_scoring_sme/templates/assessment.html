{% extends "base.html" %}

{% block title %}Assessment{% endblock %}

{% block content %}
<div class="container">
    <script>
        // Check for repeated access before anything else
        {% if not user %}
        if (localStorage.getItem('has_assessed') === 'true') {
            window.location.href = "/signup?reason=limit";
        }
        {% endif %}
    </script>
    
    {% if not result %}
    <!-- Wizard Section -->
    <div id="wizard-content">
        <header style="text-align: center; margin-bottom: 3rem;">
            <p style="text-transform: uppercase; letter-spacing: 0.2em; font-weight: 700; font-size: 0.75rem; color: var(--amber);">Credit Journey</p>
            <h1 style="font-size: 3.5rem;">{% if user %}{{ user.email.split('@')[0] }}'s Performance{% else %}The Performance Story{% endif %}</h1>
        </header>

        <div class="journey-container">
            <span class="journey-label">Risk Pulse</span>
            <div class="journey-meter">
                <div class="journey-indicator"></div>
            </div>
            <span class="journey-label">Potential</span>
        </div>

        <div class="progress-bar-container">
            <div class="progress-fill"></div>
        </div>

        <div class="wizard-container">
            <form id="wizard-form" action="/assessment" method="post">
                <!-- Step 1: Revenue -->
                <div class="step-card active">
                    <label class="question-label" for="daily_revenue">What is your average daily revenue?</label>
                    <input type="number" class="input-field" id="daily_revenue" name="daily_revenue" step="0.01" placeholder="0.00" value="{{ inputs.daily_revenue if inputs else '' }}" required>
                    <p class="input-subtext">This defines your business velocity and scale.</p>
                    <div style="margin-top: 3rem;">
                        <button type="button" class="btn-next btn-primary">Establish Flow</button>
                    </div>
                </div>

                <!-- Step 2: Expenses -->
                <div class="step-card">
                    <label class="question-label" for="daily_expenses">And your daily operating overhead?</label>
                    <input type="number" class="input-field" id="daily_expenses" name="daily_expenses" step="0.01" placeholder="0.00" value="{{ inputs.daily_expenses if inputs else '' }}" required>
                    <p class="input-subtext">We analyze this against revenue to determine stability.</p>
                    <div style="margin-top: 3rem;">
                        <button type="button" class="btn-next btn-primary">Define Efficiency</button>
                    </div>
                </div>

                <!-- Step 3: Marketing -->
                <div class="step-card">
                    <label class="question-label" for="ad_spend">How much do you invest in growth?</label>
                    <input type="number" class="input-field" id="ad_spend" name="ad_spend" step="0.01" placeholder="0.00" value="{{ inputs.ad_spend if inputs else '' }}" required>
                    <p class="input-subtext">Marketing efficiency is a leading indicator of future health.</p>
                    <div style="margin-top: 3rem;">
                        <button type="button" class="btn-next btn-primary">Next Step</button>
                    </div>
                </div>

                <!-- Step 4: Transactions -->
                <div class="step-card">
                    <label class="question-label" for="num_transactions">What is your daily transaction volume?</label>
                    <input type="number" class="input-field" id="num_transactions" name="num_transactions" placeholder="0" value="{{ inputs.num_transactions if inputs else '' }}" required>
                    <p class="input-subtext">Frequency helps us validate the consistency of your story.</p>
                    <div style="margin-top: 3rem;">
                        {% if user %}
                            <button type="button" class="btn-next btn-primary">Analyze Intent</button>
                        {% else %}
                            <button type="button" id="submit-btn" class="btn-primary">Generate Final Insight</button>
                        {% endif %}
                    </div>
                </div>

                {% if user %}
                <!-- Step 5: Account Holder Insight (Premium) -->
                <div class="step-card">
                    <header style="margin-bottom: 2rem;">
                        <span style="font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--amber); letter-spacing: 0.1em;">Account Holder Insight</span>
                        <h2 style="font-size: 2rem; margin-top: 0.5rem;">Loan Readiness Analysis</h2>
                    </header>
                    
                    <div style="display: flex; flex-direction: column; gap: 2rem; text-align: left;">
                        <div class="slider-group">
                            <label class="question-label" style="font-size: 1.1rem;" for="loan_purpose">What do you plan to use this loan for?</label>
                            <select id="loan_purpose" name="loan_purpose" class="input-field" style="background: white; border: 1px solid rgba(0,0,0,0.1); padding: 1rem; cursor: pointer;">
                                <option value="Business expansion" {% if inputs and inputs.get('loan_purpose') == 'Business expansion' %}selected{% endif %}>Business expansion</option>
                                <option value="Inventory or stock" {% if inputs and inputs.get('loan_purpose') == 'Inventory or stock' %}selected{% endif %}>Inventory or stock</option>
                                <option value="Marketing / advertising" {% if inputs and inputs.get('loan_purpose') == 'Marketing / advertising' %}selected{% endif %}>Marketing / advertising</option>
                                <option value="Equipment or tools" {% if inputs and inputs.get('loan_purpose') == 'Equipment or tools' %}selected{% endif %}>Equipment or tools</option>
                                <option value="Emergency / cash support" {% if inputs and inputs.get('loan_purpose') == 'Emergency / cash support' %}selected{% endif %}>Emergency / cash support</option>
                            </select>
                        </div>

                        <div class="slider-group">
                            <label class="question-label" style="font-size: 1.1rem;" for="business_age">How long has your business been operating?</label>
                            <select id="business_age" name="business_age" class="input-field" style="background: white; border: 1px solid rgba(0,0,0,0.1); padding: 1rem; cursor: pointer;">
                                <option value="Less than 6 months" {% if inputs and inputs.get('business_age') == 'Less than 6 months' %}selected{% endif %}>Less than 6 months</option>
                                <option value="6-12 months" {% if inputs and inputs.get('business_age') == '6-12 months' %}selected{% endif %}>6-12 months</option>
                                <option value="1-3 years" {% if inputs and inputs.get('business_age') == '1-3 years' %}selected{% endif %}>1-3 years</option>
                                <option value="Over 3 years" {% if inputs and inputs.get('business_age') == 'Over 3 years' %}selected{% endif %}>Over 3 years</option>
                            </select>
                        </div>

                        <div class="slider-group">
                            <label class="question-label" style="font-size: 1.1rem;" for="repayment_confidence">If approved, how confident are you in repaying this loan on time?</label>
                            <select id="repayment_confidence" name="repayment_confidence" class="input-field" style="background: white; border: 1px solid rgba(0,0,0,0.1); padding: 1rem; cursor: pointer;">
                                <option value="Very confident" {% if inputs and inputs.get('repayment_confidence') == 'Very confident' %}selected{% endif %}>Very confident</option>
                                <option value="Somewhat confident" {% if inputs and inputs.get('repayment_confidence') == 'Somewhat confident' %}selected{% endif %}>Somewhat confident</option>
                                <option value="Unsure" {% if inputs and inputs.get('repayment_confidence') == 'Unsure' %}selected{% endif %}>Unsure</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-top: 3rem;">
                        <button type="button" id="submit-btn" class="btn-primary">Generate Final Insight</button>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Dramatic Loading Screen -->
    <div id="loading-screen" style="display: none; text-align: center; padding: 10rem 0;">
        <div class="reveal-anim">
            <h2 style="font-size: clamp(1.5rem, 4vw, 2.5rem); margin-bottom: 2rem; font-family: 'Outfit';">Synthesizing Performance Vectors...</h2>
            <div style="width: 240px; height: 1px; background: rgba(0,0,0,0.1); margin: 0 auto; position: relative; overflow: hidden;">
                <div style="position: absolute; width: 60%; height: 100%; background: var(--forest); animation: slideLeft 1.2s infinite ease-in-out;"></div>
            </div>
            <p style="margin-top: 2rem; opacity: 0.6; font-size: 0.9rem; letter-spacing: 0.1em; text-transform: uppercase;">Connecting to Alternative Risk Core v1</p>
        </div>
    </div>
</div>

<style>
@keyframes slideLeft {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(200%); }
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='/js/script.js') }}"></script>
{% endblock %}
